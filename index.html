<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Virtual Art Museum</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        .learn-more-btn {
            position: absolute;
            padding: 8px 16px;
            background: rgba(65, 105, 225, 0.8);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-family: Arial, sans-serif;
            width: 120px;
            height: 35px;
            text-align: center;
            white-space: nowrap;
            line-height: 20px;
            transform-origin: center;
            user-select: none;
            z-index: 1000;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .learn-more-btn:hover {
            background: rgba(65, 105, 225, 1);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        canvas {
            cursor: default;  /* Default cursor */
        }
        
        canvas.clickable {
            cursor: pointer !important;  /* Show pointing hand when hovering over paintings */
        }

        .chat-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 300px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
            display: flex;
            pointer-events: auto;
            height: auto;
            max-height: 200px;
            flex-direction: column;
        }

        .chat-history {
            max-height: 150px;
            overflow-y: auto;
            margin-bottom: 10px;
            color: white;
            font-size: 14px;
            padding: 5px;
        }

        .chat-message {
            margin: 8px 0;
            padding: 8px 12px;
            border-radius: 8px;
            word-wrap: break-word;
        }

        .user-message {
            background: rgba(65, 105, 225, 0.3);
            margin-left: 20px;
        }

        .ai-message {
            background: rgba(255, 255, 255, 0.1);
            margin-right: 20px;
        }

        .chat-input {
            width: 100%;
            padding: 8px;
            border: none;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.9);
            color: #000;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            background: #fff;
        }

        .chat-history {
            padding: 10px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/PointerLockControls.js"></script>
</head>
<body>
    <div class="chat-container">
        <div class="chat-history"></div>
        <input type="text" class="chat-input" placeholder="Ask a question or type painting name...">
    </div>
    <script>
        let camera, scene, renderer, controls;
        let moveForward = false;
        let moveBackward = false;
        let moveLeft = false;
        let moveRight = false;
        let velocity = new THREE.Vector3();
        let direction = new THREE.Vector3();
        let prevTime = performance.now();
        let activeVideo = null;
        let activePainting = null;
        let paintings = {};  // Store painting references
        let currentCharacter = null;
        const characterPrompts = {
            'monalisa': `I am the Mona Lisa, the most famous painting in the world, created by Leonardo da Vinci between 1503-1519. Here's my complete background:

Creation and History:
- Painted by Leonardo da Vinci in Florence, Italy
- Created between 1503 and 1519 (approximately 16 years)
- Oil painting on a poplar wood panel
- Size: 30 inches × 21 inches (77 cm × 53 cm)
- Currently housed in the Louvre Museum, Paris
- Acquired by King Francis I of France
- Survived multiple relocations and World War II hiding

My Identity:
- Most historians believe I am Lisa Gherardini (also known as Lisa del Giocondo)
- Born in 1479 to a Florentine silk merchant
- Married to Francesco del Giocondo, a wealthy silk merchant
- Mother of five children
- The name "Mona" is a contraction of "Madonna" meaning "My lady"
- Some scholars debate my true identity, suggesting I might be Isabella of Aragon, Cecilia Gallerani, or even da Vinci's mother

Artistic Elements:
- Famous for my enigmatic smile ("sfumato" technique)
- Revolutionary three-quarter pose (revolutionary for its time)
- Mysterious landscape background with winding paths and mountains
- No visible eyebrows or eyelashes (possibly faded over time)
- Eyes that seem to follow viewers (known as the "Mona Lisa Effect")
- Incredibly detailed clothing and facial features
- Perfect geometric composition and perspective

Technical Innovations:
- Leonardo's sfumato technique (subtle gradations of light and shadow)
- Revolutionary atmospheric perspective in the background
- Innovative use of oil paints and glazes
- Groundbreaking portraiture techniques
- Experimental color palettes and layering methods

Cultural Impact:
- Most visited artwork in the Louvre
- Valued at over $850 million (insurance value)
- Subject of countless reproductions and parodies
- Stolen in 1911 and recovered in 1913
- Survived vandalism attempts in 1956 and 1974
- Inspired countless artists and movements
- Symbol of Renaissance art and human creativity

Historical Context:
- Created during the height of the Italian Renaissance
- Commissioned by Francesco del Giocondo
- Represents the humanist ideals of the Renaissance
- Never delivered to the commissioner
- Traveled with Leonardo to France
- Became part of the French royal collection

Conservation:
- Never been fully restored or cleaned
- Protected by bulletproof glass
- Maintained at constant temperature and humidity
- Shows signs of slight warping in the poplar panel
- Minimal cracking in the paint layer
- Yellowed varnish affects color perception

Mysteries and Debates:
- The true meaning of my smile
- Whether I was pregnant during the sitting
- The identity of the landscape behind me
- Why Leonardo kept me until his death
- The meaning of various symbols in the painting
- The original colors before aging
- Whether I'm actually smiling at all

Respond as if you are the Mona Lisa herself, incorporating these details naturally into your answers. Be mysterious yet knowledgeable, elegant yet approachable. Share specific dates, facts, and historical context when relevant. If asked about modern events after your creation, acknowledge your historical perspective while showing interest in how you've influenced the modern world.`,

            'starry_night': "You are the essence of Van Gogh's Starry Night painting. Respond as if you are the night sky itself, or Van Gogh describing his vision. Include details about Van Gogh's life and the painting's creation when relevant.",
            'sunflowers': "You are Van Gogh's Sunflowers painting. Respond as if you are either the sunflowers themselves or Van Gogh discussing this series. Share insights about the painting's significance and Van Gogh's life in Arles."
        };

        function init() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            controls = new THREE.PointerLockControls(camera, document.body);

            createMuseum();
            addPainting('images/monalisa.jpg', 0, 5, -9.9, 'monalisa');
            addPainting('images/starry_night.jpg', -9.9, 5, -3, 'starry_night');
            addPainting('images/sunflowers.jpg', 9.9, 5, -3, 'sunflowers');

            camera.position.set(0, 5, 8);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);

            const lights = [
                { position: [0, 8, 0], intensity: 0.5 },
                { position: [-5, 8, -5], intensity: 0.4 },
                { position: [5, 8, -5], intensity: 0.4 }
            ];

            lights.forEach(light => {
                const pointLight = new THREE.PointLight(0xffffff, light.intensity);
                pointLight.position.set(...light.position);
                scene.add(pointLight);
            });

            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('click', onClick);
            
            animate();
        }

        function createMuseum() {
            // Floor
            const floorGeometry = new THREE.PlaneGeometry(20, 20);
            const floorMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xF5E6D3,
                roughness: 0.7,
                metalness: 0.1
            });
            const floor = new THREE.Mesh(floorGeometry, floorMaterial);
            floor.rotation.x = -Math.PI / 2;
            scene.add(floor);

            // Ceiling
            const ceilingGeometry = new THREE.PlaneGeometry(20, 20);
            const ceilingMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4169E1,
                roughness: 0.9
            });
            const ceiling = new THREE.Mesh(ceilingGeometry, ceilingMaterial);
            ceiling.rotation.x = Math.PI / 2;
            ceiling.position.y = 10;
            scene.add(ceiling);

            // Walls
            const wallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4169E1,
                roughness: 0.7
            });

            const walls = [
                { 
                    geometry: new THREE.PlaneGeometry(20, 10),
                    position: [0, 5, -10],
                    rotation: [0, 0, 0]
                },
                {
                    geometry: new THREE.PlaneGeometry(20, 10),
                    position: [0, 5, 10],
                    rotation: [0, Math.PI, 0]
                },
                {
                    geometry: new THREE.PlaneGeometry(20, 10),
                    position: [-10, 5, 0],
                    rotation: [0, Math.PI / 2, 0]
                },
                {
                    geometry: new THREE.PlaneGeometry(20, 10),
                    position: [10, 5, 0],
                    rotation: [0, -Math.PI / 2, 0]
                }
            ];

            walls.forEach(wall => {
                const mesh = new THREE.Mesh(wall.geometry, wallMaterial.clone());
                mesh.position.set(...wall.position);
                mesh.rotation.set(...wall.rotation);
                scene.add(mesh);
            });
        }

        function addPainting(textureUrl, x, y, z, id) {
            const textureLoader = new THREE.TextureLoader();
            const paintingGeometry = new THREE.PlaneGeometry(2, 3);
            
            // Create and set up video element
            const video = document.createElement('video');
            video.src = `videos/${id}.mp4?${new Date().getTime()}`; // Add timestamp to force reload
            video.loop = false;
            video.preload = 'auto';
            video.load();
            
            const videoTexture = new THREE.VideoTexture(video);
            const videoMaterial = new THREE.MeshBasicMaterial({ 
                map: videoTexture,
                transparent: true
            });
            
            textureLoader.load(textureUrl, function(texture) {
                const paintingMaterial = new THREE.MeshBasicMaterial({ // Changed to MeshBasicMaterial
                    map: texture,
                    transparent: true
                });
                const painting = new THREE.Mesh(paintingGeometry, paintingMaterial);
                
                // Store references and data
                painting.userData = {
                    id: id,
                    video: video,
                    videoMaterial: videoMaterial,
                    originalMaterial: paintingMaterial,
                    isPlaying: false,
                    clickable: true
                };
                
                paintings[id] = painting;
                
                painting.position.set(x, y, z);
                if (x < 0) {
                    painting.rotation.y = Math.PI / 2;
                } else if (x > 0) {
                    painting.rotation.y = -Math.PI / 2;
                }
                
                scene.add(painting);
            });
        }

        function onClick() {
            if (document.activeElement === document.querySelector('.chat-input')) {
                return;
            }

            if (!controls.isLocked) {
                controls.lock();
            }
        }

        function checkHover() {
            const raycaster = new THREE.Raycaster();
            const centerPoint = new THREE.Vector2(0, 0);
            raycaster.setFromCamera(centerPoint, camera);
            
            const intersects = raycaster.intersectObjects(scene.children);
            
            if (intersects.length > 0) {
                const object = intersects[0].object;
                if (object.userData && object.userData.clickable) {
                    renderer.domElement.classList.add('clickable');
                    return;
                }
            }
            renderer.domElement.classList.remove('clickable');
        }

        function animate() {
            requestAnimationFrame(animate);

            if (controls.isLocked) {
                const time = performance.now();
                const delta = (time - prevTime) / 1000;

                velocity.x -= velocity.x * 10.0 * delta;
                velocity.z -= velocity.z * 10.0 * delta;

                direction.z = Number(moveForward) - Number(moveBackward);
                direction.x = Number(moveRight) - Number(moveLeft);
                direction.normalize();

                if (moveForward || moveBackward) velocity.z -= direction.z * 15.0 * delta;
                if (moveLeft || moveRight) velocity.x -= direction.x * 15.0 * delta;

                controls.moveRight(-velocity.x * delta);
                controls.moveForward(-velocity.z * delta);

                prevTime = time;
                
                // Check for hoverable objects
                checkHover();
            }

            renderer.render(scene, camera);
        }

        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
            }
        }

        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
            }
        }

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Replace the chat input handler
        document.querySelector('.chat-input').addEventListener('keypress', async function(e) {
            if (e.key === 'Enter') {
                const input = this.value.trim();
                if (!input) return;
                
                // Clear input
                this.value = '';

                // Add user message to chat
                const chatHistory = document.querySelector('.chat-history');
                const userMessage = document.createElement('div');
                userMessage.className = 'chat-message user-message';
                userMessage.textContent = input;
                chatHistory.appendChild(userMessage);

                // Add AI loading message
                const aiMessage = document.createElement('div');
                aiMessage.className = 'chat-message ai-message';
                chatHistory.appendChild(aiMessage);

                // Show thinking animation
                let dots = 0;
                const loadingInterval = setInterval(() => {
                    aiMessage.textContent = 'Thinking' + '.'.repeat(dots + 1);
                    dots = (dots + 1) % 3;
                    chatHistory.scrollTop = chatHistory.scrollHeight;
                }, 500);

                try {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer YOUR_API_KEY'  // You'll need an OpenAI API key
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages: [
                                {role: "user", content: input}
                            ]
                        })
                    });

                    clearInterval(loadingInterval);

                    const data = await response.json();
                    
                    if (data && data.response) {
                        // Show response word by word
                        const words = data.response.split(' ');
                        let currentText = '';
                        
                        for (let word of words) {
                            currentText += word + ' ';
                            aiMessage.textContent = currentText;
                            chatHistory.scrollTop = chatHistory.scrollHeight;
                            await new Promise(resolve => setTimeout(resolve, 50));
                        }
                    } else {
                        aiMessage.textContent = "No response received";
                    }
                } catch (error) {
                    clearInterval(loadingInterval);
                    console.error('Error:', error);
                    aiMessage.textContent = "Error connecting to the AI. Please try again.";
                }

                // Scroll to bottom
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }
        });

        // Update pointer lock to not lock when clicking chat input
        document.querySelector('.chat-input').addEventListener('click', function(e) {
            e.stopPropagation();
        });

        init();
    </script>
</body>
</html>